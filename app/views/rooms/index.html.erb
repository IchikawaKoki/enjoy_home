<div class = "container">
  <div class = "row">
    <div class = "col-3 mx-auto content-title">
      <h3 class = "text-center">チャット</h3>
    </div>
  </div>
  <div class = "row">
    <% if @rooms.empty? %>
      <p>現在チャット相手はいません</p>
    <% else %>
      <table class = "table">
        <thead>
          <tr>
            <th>相手</th>
            <th>最終発言内容</th>
            <th>最終発言者</th>
            <th>最終発言日時</th>
            <th colspan = "3"></th>
          </tr>
        </thead>
        <tbody>
          <% @rooms.each do |room| %>
            <% entry_user_id = room.user_rooms.where.not(user_id: current_user.id).pluck(:user_id) %>
              <tr>
                <td><%= User.find_by(id: entry_user_id).name %></td>
                <% unless room.chats.empty? %>
                  <td><%= Chat.where(id: room.chats).last.message %></td>
                  <td>
                    <% last_chatter = Chat.where(id: room.chats).last.user %>
                    <% if last_chatter == current_user %>
                      あなた
                    <% else %>
                      <%= last_chatter.name %>
                    <% end %>
                  </td>
                  <td><%= Chat.where(id: room.chats).last.created_at.strftime('%Y年%m月%d日%H時%M分') %></td>
                <% else %>
                  <td>---</td>
                  <td>---</td>
                  <td>---</td>
                <% end %>
                <td><%= link_to "チャットへ", room_path(room.id), class: "btn btn-info" %></td>
              </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
  <div class = "row">
    <% if @no_entries.empty? %>
      全会員とチャットをしています!!
     <% else %>
      <%= form_with model: @user_room, url: rooms_path, local: true do |f| %>
        <div class = "form-group">
          <%= f.label :user_id, "新しくチャットを始める相手を選んでください" %>
          <%= f.collection_select :user_id, @no_entries, :id, :name %>
          <%= f.submit "開始する" %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>